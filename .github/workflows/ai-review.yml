name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    branches:
      - '**'
  pull_request_target:
    types: [opened, synchronize, reopened, edited]
    branches:
      - '**'
  workflow_dispatch:

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    timeout-minutes: 15
    steps:
      - name: Collect PR changes (files + patches)
        id: collect
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request || context.payload.issue?.pull_request;
            const pull_number = pr ? (context.payload.pull_request?.number || context.issue.number) : context.issue.number;
            const {data: files} = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number,
              per_page: 100
            });
            const summaries = files.map(f => `# ${f.filename} (status: ${f.status})\n\n\n${f.patch || ''}`).join('\n\n---\n\n');
            const fs = require('fs');
            const prompt = `以下はPRの差分です。次のフォーマットで日本語レビューを生成してください。\n\n` +
            `# AI レビュー\n` +
            `- 結論: OK | 要修正 | 注意 のいずれかを先頭に記載\n\n` +
            `## 良い点\n` +
            `- 最大5項目で、具体的に（何が・なぜ良いか）\n\n` +
            `## 改善点（優先度付き）\n` +
            `- [高/中/低] 問題: … / 影響: … / 根拠: … / 対応例:\n` +
            "```diff\n- 悪い例\n+ 良い例\n```\n\n" +
            `## 即時の修正提案\n` +
            `- 実際の修正スニペットを提示（Rationaleを1行で）\n\n` +
            `## チェックリスト\n` +
            `- [ ] CIトリガー/パスは意図通り\n` +
            `- [ ] シークレット漏洩なし（フォークPR対策済）\n` +
            `- [ ] ログは過不足なし（機微情報非出力）\n` +
            `- [ ] 失敗時アーティファクトで診断可能\n` +
            `- [ ] セキュリティ上の危険な実行（checkoutなど）無し\n\n` +
            `## 最終評価\n` +
            `評価: OK | 要修正 のいずれかを単独行で\n\n` +
            `--- 差分 ---\n\n` + summaries;
            const truncated = prompt.length > 120000 ? prompt.slice(0, 120000) + '\n\n...（一部省略）' : prompt;
            fs.writeFileSync('review_input.txt', truncated);
            const filesList = files.map(f => `${f.filename} (${f.status})`).join('\n');
            fs.writeFileSync('files_summary.txt', filesList || '(no files)');
            core.setOutput('files_count', (files?.length ?? 0).toString());
            core.setOutput('pull_number', pull_number.toString());

      - name: Show input size
        run: |
          BYTES=$(wc -c < review_input.txt || echo 0)
          echo "::notice::review_input size(bytes)=${BYTES}"

      - name: Show changed files
        run: |
          echo "::group::Changed files"
          test -f files_summary.txt && cat files_summary.txt || echo "(no files)"
          echo "::endgroup::"

      - name: AI review via Gemini
        # Google AI Studio(Generative Language API) の API Key を使用
        if: ${{ secrets.GOOGLE_API_KEY }}
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL || 'gemini-1.5-pro-latest' }}
        run: |
          set -euo pipefail
          echo "::group::Install jq"
          sudo apt-get -yqq update >/dev/null 2>&1 || true
          sudo apt-get -yqq install jq >/dev/null 2>&1
          jq --version
          echo "::endgroup::"

          echo '::notice::Calling Gemini API'
          BODY=$(jq -n --arg text "$(sed 's/\\/\\\\/g; s/\"/\\\"/g' review_input.txt | tr -d '\r')" '{
            contents: [{ role: "user", parts: [{ text: $text }]}],
            generationConfig: { temperature: 0.2 }
          }')
          HTTP_CODE=$(curl -sS -w '%{http_code}' -X POST "https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GOOGLE_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$BODY" \
            -o response.json)

          # 返却テキストのみ抽出（ログを簡潔化）。失敗時は簡潔なメッセージにフォールバック。
          jq -r '(.candidates[0].content.parts[0].text // .candidates[0].content // .promptFeedback // .error.message // "レビュー生成失敗" )' response.json > review.md
          FINISH=$(jq -r '.candidates[0].finishReason // .candidates[0].finish_reason // "UNKNOWN"' response.json)
          BLOCKED=$(jq -r '.promptFeedback.blockReason // ""' response.json)
          OUT_LEN=$(wc -c < review.md || echo 0)
          PREVIEW=$(head -c 200 review.md | tr '\n' ' ')

          echo '::group::AI Review Summary'
          echo "HTTP=${HTTP_CODE} MODEL=${GEMINI_MODEL} FINISH=${FINISH} BLOCK=${BLOCKED}"
          echo "OUTPUT_BYTES=${OUT_LEN}"
          echo "PREVIEW: ${PREVIEW}..."
          echo '::endgroup::'

      - name: Skip (no AI credentials found)
        if: ${{ !secrets.GOOGLE_API_KEY }}
        run: |
          echo "No Gemini API key found. Skipping AI review." > review.md

      - name: Build final PR comment
        run: |
          {
            echo '## 変更ファイル';
            test -f files_summary.txt && sed 's/^/- /' files_summary.txt || echo '(no files)';
            echo;
            echo '## AI レビュー';
            cat review.md;
          } > comment.md

      - name: Upload debug artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ai-review-debug
          path: |
            review_input.txt
            response.json

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('comment.md','utf8');
            const pull_number = (context.payload.pull_request && context.payload.pull_request.number) || context.issue.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pull_number,
              body
            });
          result-encoding: string
          
