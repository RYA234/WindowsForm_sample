name: Copilot Instructions Check

on:
  push:
    branches:
      - '**'
    paths:
      - '.github/copilot-instructions.md'
      - '.github/workflows/**'
  pull_request:
    branches:
      - '**'
    paths:
      - '.github/copilot-instructions.md'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  validate:
    permissions:
      contents: read
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate .github/copilot-instructions.md
        shell: bash
        run: |
          set -euo pipefail
          FILE=".github/copilot-instructions.md"
          if [[ ! -f "$FILE" ]]; then
            echo "::error title=Missing file::$FILE not found"; exit 1
          fi
          if [[ ! -s "$FILE" ]]; then
            echo "::error title=Empty file::$FILE is empty"; exit 1
          fi
          missing=()
          mapfile -t req << 'EOF'
          # UI Propety
          ## テキストボックス　TextBox
          ## DateTimePicker
          # 結果の連絡について
          # 修正方法について
          EOF
          for h in "${req[@]}"; do
            if ! grep -Fq "$h" "$FILE"; then
              missing+=("$h")
            fi
          done
          if (( ${#missing[@]} > 0 )); then
            printf "::error title=Missing sections::%s\n" "$(IFS=", "; echo "${missing[*]}")"
            exit 1
          fi

          # 結果テーブルのフォーマットを検証（場所は問わず、ヘッダー行と区切り行の存在を確認）
          # パイプの前後の空白や全角スペース差異を許容した正規表現で検証
          if ! grep -Eaq 'プロパティ名\s*\|\s*プロパティ項目\s*\|\s*結果\s*\|\s*現状の値\s*\|\s*期待する値\s*\|\s*修正方法' "$FILE"; then
            echo "::error title=Missing result table::ヘッダー行が見つかりません"; exit 1
          fi
          if ! grep -Eaq '^[-\s|]{3,}\|[-\s|]{3,}(\|[-\s|]{3,}){4}\s*$' "$FILE"; then
            echo "::error title=Missing result table separator::区切り行が見つかりません"; exit 1
          fi
          echo "All required sections exist."
          {
            echo "### Copilot Instructions Check"
            echo "- File: $FILE"
            echo "- Status: OK"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Dump instructions on failure
        if: failure()
        shell: bash
        run: |
          echo '--- .github/copilot-instructions.md (tail) ---'
          tail -n 100 .github/copilot-instructions.md || true

      - name: Upload instructions as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: copilot-instructions
          path: .github/copilot-instructions.md
